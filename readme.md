# Peat

PHP-Vite bridge building tool, for any framework.

> ðŸ’¿ `composer require dakujem/peat`


This tool helps integrate Vite-bundled JS apps into PHP-served web pages.

It provides a way to generate `<script>` and `<link>` tags to desired assets.


## Vite

Vite (a.k.a. Vite.js) consists of 2 parts:
- _development server_
- and _bundler_.

To integrate a JS app, the backend must output snippets like these:
- files from a _bundle_ (production)
    ```html
    <!-- PRODUCTION -->
    <script type="module" src="/placeholder/assets/main.cf1f50e2.js"></script>
    <script type="module" src="/placeholder/assets/vendor.5f8262d6.js"></script>
    <link rel="stylesheet" href="/placeholder/assets/main.c9fc69a7.css" />
    ```
- links to files served by _development server_
    ```html
    <!-- DEVELOPMENT -->
    <script type="module" src="http://localhost:5173/@vite/client"></script>
    <script type="module" src="http://localhost:5173/src/main.js"></script>
    ```

For best development experience, we only want to care about `main.js` as the entry point of the JS app in both cases.\
Ideally, we want to achieve something like the following:
```html
  <!-- PHP template -->
  <?php echo vite('main.js'); ?>
  
  <!-- or other templating systems, like Twig -->
  {{ vite('main.js') }}
```

To achieve this, Peat reads the _manifest_ JSON file generated by Vite for each bundle.\
In development, we simply serve the entrypoint (along with `@vite/client` supporting library),
and the browser will load the rest of the files as ES modules.


### Vite configuration

Vite (`vite.config.js`) must be configured to output a _manifest_ file and override the default entrypoint:

- `build.manifest` must be set to `true`
- `build.rollupOptions.input` should point to the `main.js` (or other JS entrypoint)

More info in the [Vite's Backend integration guide](https://vitejs.dev/guide/backend-integration.html).

> ðŸ’¡
> 
> You may also want to set `build.outDir` to point to a sub folder in the backend's public dir,
> so that you don't have to move the build files manually after each build.


## Bridge usage

Either `ViteBridge::makePassiveEntryLocator` friction reducer can be used,
or custom entry locator setup can be composed.

To pre-generate cache for production, use `ViteBundleLocator::populateCache`.

To get asset URLs (or HTML tags), use the `ViteLocatorContract::entry` method (see the example below).


### Cache

It is also possible to improve performance
by exporting the manifest contents into a PHP cache file,
then including it instead of parsing the JSON file.

This is achieved by calling `ViteBuildLocator::populateCache()`
as one of the build steps during the deployment/ci process.


## Example

Assume JS sources are located in `<project>/js/src` and the public dir is `<project>/public`,
`my-js-widget` may be replaced with any path.

Configure Vite like this:
```js
// vite.config.js
import {defineConfig} from "vite";

export default defineConfig({
  build: {
    manifest: true,
    outDir: '../public/my-js-widget', // output directly to the public dir
    rollupOptions: {
      // overwrite default .html entrypoint
      input: 'src/main.js',
    }
  }
});
```

Register a service in your service container:
```php
$bridgeService = new ViteBridge(
    manifestFile: ROOT_DIR . '/public/my-js-widget/manifest.json',
    cacheFile: TEMP_DIR . '/vite.php',   // can be any writable file
    assetPath: 'my-js-widget',   // relative path from /public to the dir where the manifest is located
    devServerUrl: 'http://localhost:5173',
);
```

And use it:
```php
$locator = $bridgeService->makePassiveEntryLocator(useDevServer: $isDevelopment);
$html = (string) $locator->entry('src/main.js');
```

The above will feed all the necessary HTML tags for `main.js` entrypoint to the `$html` variable,
for both the _devleopment server_ and any _bundle_ (depending on the `$isDevelopment` variable).

You may want to register a method that uses the locator to be called from within your templates.

To populate cache, run:
```php
$bridgeService->populateCache();
```


## Compatibility

Please note that this tool (Peat) is tightly coupled with the workings of Vite.

Currently, Peat supports Vite versions `2` and above.

| PHP       | Peat | Vite.js   |
|:----------|:-----|:----------|
| 7.4 - 8.* | 1.*  | 2.* - 4.* |

> Unless there is a breaking change in the way Vite.js generates its `manifest.json` file,
> Peat will remain compatible with future versions of Vite.js.


## Integrations

- [Vitte: Vite bridge for Latte templates (Nette Framework)](https://github.com/viaaurea/vitte)
